name: Version Check

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  version-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    
    - name: Check schema version matches project version
      run: |
        # Extract versions from files
        MAJOR=$(grep "SET.*VERSION_MAJOR" CMakeLists.txt | grep -oP '\d+' || echo "")
        MINOR=$(grep "SET.*VERSION_MINOR" CMakeLists.txt | grep -oP '\d+' || echo "")
        PATCH=$(grep "SET.*VERSION_PATCH" CMakeLists.txt | grep -oP '\d+' || echo "")
        SCHEMA_VERSION=$(grep "schema_version:" edm4eic.yaml | grep -oP '\d+' || echo "")
        
        # Verify all values were extracted
        if [ -z "$MAJOR" ] || [ -z "$MINOR" ] || [ -z "$PATCH" ]; then
          echo "ERROR: Failed to extract version from CMakeLists.txt"
          echo "  MAJOR='${MAJOR}' MINOR='${MINOR}' PATCH='${PATCH}'"
          exit 1
        fi
        
        if [ -z "$SCHEMA_VERSION" ]; then
          echo "ERROR: Failed to extract schema_version from edm4eic.yaml"
          exit 1
        fi
        
        # Calculate expected schema version (100*major + minor)
        EXPECTED_SCHEMA_VERSION=$((MAJOR * 100 + MINOR))
        
        echo "Project version: ${MAJOR}.${MINOR}.${PATCH}"
        echo "Schema version: ${SCHEMA_VERSION}"
        echo "Expected schema version: ${EXPECTED_SCHEMA_VERSION}"
        
        # Verify they match
        if [ "$SCHEMA_VERSION" != "$EXPECTED_SCHEMA_VERSION" ]; then
          echo "ERROR: Schema version mismatch!"
          echo "  edm4eic.yaml has schema_version=${SCHEMA_VERSION}"
          echo "  CMakeLists.txt version ${MAJOR}.${MINOR}.${PATCH} requires schema_version=${EXPECTED_SCHEMA_VERSION}"
          echo "  Please update schema_version in edm4eic.yaml to ${EXPECTED_SCHEMA_VERSION}"
          exit 1
        fi
        
        echo "âœ“ Schema version matches project version"
